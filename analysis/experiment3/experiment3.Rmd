---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(ggthemes)
library(broom.mixed)
library(lme4)
```

# Scores

Compute coarse score plot

```{r}
inactive_pids <- read_csv(here('data/experiment3/inactive_games.csv'), col_names = c('pid')) %>% pull(pid)
d.exp3.raw <- dir('../../data/experiment3/', pattern = "experiment*", include.dirs = T,
                          recursive = F, full.names = T) %>%
  dir(pattern = '^games$', include.dirs = T, full.names = T, recursive = F) %>%
  dir(pattern = '*.csv', full.names = T, recursive = F) %>%
  map_df(~ suppressMessages(read_csv(., col_types = 'cicdddidd') %>% mutate(filename = .x))) %>%
  group_by(filename) %>%
  mutate(half = ifelse(tick < max(tick)/2, 'first', 'second')) 

#d.exp3.raw.alt <- read_csv(here('analysis/experiment3/data_raw.csv'))
  
d.exp3 <- d.exp3.raw %>%
  group_by(filename, pid, half) %>%
  summarize(avg_score = mean(bg_val)) %>%
  separate(filename, into = c('date', 'n_players_planned', 'noise-difficulty', 'gameid'), sep = '_') %>%
  separate(`noise-difficulty`, into = c('noise', 'difficulty'), sep = '-') %>%
  group_by(gameid) %>%
  mutate(n_players = length(unique(pid))) %>%
  mutate(difficulty = ifelse(difficulty == '2en01', 'high', 'low')) %>%
  filter(n_players < 6) 

scores.toplot <- d.exp3 %>%
  group_by(half, n_players, difficulty) %>%
  tidyboot::tidyboot_mean(avg_score)
  
scores.toplot %>%
  ungroup() %>%
  filter(half == 'second') %>%
  mutate(difficulty = ifelse(difficulty == "high", "high noise", "low noise")) %>%
  ggplot(aes(x = n_players, y = empirical_stat)) +
    geom_point() +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0)+
    geom_smooth(method = 'lm', se = F) +
    facet_wrap(~ difficulty) +
    theme_few() +
    labs(x = "group size", y = "mean score") +
    theme(aspect.ratio = 1)

ggsave('performance-summary-raw.pdf')
```

```{r}
d.exp3.raw %>%
  left_join(d.exp3 %>% filter(half == 'second'), by = c('pid')) %>% 
  filter(n_players < 6) %>%
  mutate(difficulty = ifelse(difficulty == "high", "high noise", "low noise")) %>%
  group_by(tick, difficulty, n_players) %>%
  summarize(avg_score = mean(bg_val)) %>%
  ggplot(aes(x = tick, y = avg_score)) +
    geom_point() +
    geom_smooth(method = 'lm', formula = y ~ poly(x, 2), se = F) +
    facet_grid(difficulty ~ n_players) +
    theme_few() +
    labs(x = "group size", y = "mean score") +
    theme(aspect.ratio = 1)
```

Statistics for scores

```{r}
d.exp3.raw %>%
  left_join(d.exp3 %>% filter(half == 'second') %>% select(-half), by = c('pid')) %>% 
  ungroup() %>%
  filter(n_players < 6) %>%
  lm(scale(bg_val, scale=F) ~ scale(n_players, scale=F) * difficulty * half,
     data = .,
     contrasts = list(difficulty = contr.sum(2),  half=contr.treatment(2, base = 2))) %>%
  summary()


d.exp3.raw %>%
  left_join(d.exp3 %>% filter(half == 'second')  %>% select(-half), by = c('pid')) %>% 
  ungroup() %>%
  #filter(n_players < 6) %>%
  lmer(scale(bg_val, scale=F) ~ scale(n_players, scale=F) * difficulty * half + (1 | gameid),
     data = .,
     contrasts = list(difficulty=contr.sum(2), half=contr.treatment(2, base = 2))) %>%
  summary()
```

```{r}
# lm.in <- d.exp3.raw.alt %>%
#   mutate(n_players = final_n_players - 3) %>%
#   gather(half, avg_score, first_half_score, second_half_score)

#lm model
lm(avg_score ~ n_players * `Noise Level` * half,
   data = lm.in,
   contrasts = list(`Noise Level`=contr.sum(2), half = contr.sum(2))) %>%
  summary()

# supplemental lmer model
library(lmerTest)
lmer(avg_score ~ n_players * `Noise Level` * half + (1  | game),
   data = lm.in,
   contrasts = list(`Noise Level`=contr.sum(2), half = contr.sum(2))) %>%
  summary()
```

# States

Read in processed data

```{r message=F}
files <- list.files(path = "../../data/experiment3/processed/", 
                    pattern = "*.csv", 
                    full.names = T)
read_csv(files[1])
d_raw <- files %>%
  map(~ read_csv(.x) %>% 
        select(pid, tick, bg_val, state, facing, going_straight, copying_exploiting, facing_spinning, copying_reward)) %>%
  reduce(bind_rows)

d <- d_raw %>%
  left_join(player_list) %>%
  filter(!is.na(noise_condition)) %>%
  mutate(state = ifelse(facing & going_straight, 'copying', state)) %>%
  mutate(copy = state == 'copying',
       exploit = state == 'exploiting',
       explore = state == 'exploring')


```

```{r}
state_counts <- d %>%
  group_by(bg_val) %>%
  mutate(len = length(state)) %>%
  group_by(bg_val, state) %>%
  summarize(total = length(tick), prop = total/mean(len))

state_proportions <- d %>%
  gather(state_bin, val, copy, exploit, explore) %>%
  group_by(bg_val, state_bin, noise_condition) %>%
  summarise(m = mean(val))
```

Plot overall proportions

```{r}
state_counts %>%
  mutate(state = fct_relevel(state, 'copying', 'exploring', 'exploiting')) %>%
  ggplot(aes(x= bg_val, y = prop, fill=state)) +
    geom_area(stat='identity', alpha = 0.5) +
    scale_fill_brewer(palette = "Set1") +
    theme_few() +
    theme(aspect.ratio = 3) +
    labs(x="background value", y="proportion in state")

ggsave('../../../couzin_replication_tex/figures/states.pdf')
```

Break out by noise condition

```{r}
state_proportions %>% 
  filter(bg_val > 0) %>%
  ggplot(aes(x = bg_val, y = m, color = state_bin, alpha = noise_condition)) +
    geom_line() +
    facet_wrap(~ state_bin) +
    theme_few() +
    theme(aspect.ratio = 1) +
    scale_color_brewer(palette = "Set1") +
    scale_alpha_discrete(range = c(0.5,1)) +
    labs(x="background value", y="proportion in state")

ggsave('../../../couzin_replication_tex/figures/states-broken-out.pdf')
```

```{r}
d %>%
  glmer(exploit ~ bg_val * noise_condition + (1 | pid) + (1 | noise),
        family = 'binomial',
        contrasts = list(half=contr.sum(2), noise_condition=contr.sum(2)),
        data = .) %>%
  summary()
```

```{r}
d %>%
  glmer(copy ~ bg_val * noise_condition + (1 | pid) + (1 | noise),
        family = 'binomial',
        contrasts = list(noise_condition=contr.sum(2)),
        data = .) %>%
  summary()
```

```{r}
d %>%
  glmer(explore ~ bg_val * noise_condition + (1 | pid) + (1 | noise),
        family = 'binomial',
        contrasts = list(noise_condition=contr.sum(2)),
        data = .) %>%
  summary()
```

```{r}
d %>%
  filter(state == 'copying') %>%
  filter(!is.na(copying_reward)) %>%
  group_by(noise_condition) %>%
  summarize(m = mean(copying_reward, na.rm=T))
```

```{r}
library(lmerTest)
d %>%
  filter(state == 'copying') %>%
  filter(!is.na(copying_reward)) %>%
  lmer(copying_reward ~ noise_condition + (1 | pid),
       data = .) %>%
  summary()
```